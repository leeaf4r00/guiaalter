{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2>üìä Dashboard em Tempo Real</h2>
        <p class="text-muted">Atualiza automaticamente a cada 30 segundos</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card card-vendas">
            <div class="stat-icon">üí∞</div>
            <div class="stat-content">
                <h3>Vendas Hoje</h3>
                <p class="stat-value" id="vendas-count">{{ vendas_count }}</p>
                <p class="stat-subtitle">{{ vendas_valor }}</p>
            </div>
        </div>

        <div class="stat-card card-caixa">
            <div class="stat-icon">üè¶</div>
            <div class="stat-content">
                <h3>Caixa</h3>
                <p class="stat-value">{% if caixa_aberto %}ABERTO{% else %}FECHADO{% endif %}</p>
                <p class="stat-subtitle stat-{% if caixa_aberto %}success{% else %}warning{% endif %}">
                    {% if caixa_aberto %}‚úÖ Em opera√ß√£o{% else %}‚ö†Ô∏è N√£o iniciado{% endif %}
                </p>
            </div>
        </div>

        <div class="stat-card card-estoque">
            <div class="stat-icon">üì¶</div>
            <div class="stat-content">
                <h3>Estoque Baixo</h3>
                <p class="stat-value stat-{% if estoque_baixo > 0 %}error{% else %}success{% endif %}"
                    id="estoque-count">
                    {{ estoque_baixo }}
                </p>
                <p class="stat-subtitle">produtos</p>
            </div>
        </div>
    </div>

    <div class="dashboard-sections">
        <div class="section">
            <div class="section-header">
                <h3>üìà √öltimas Vendas</h3>
                <button class="btn btn-sm" onclick="refreshVendas()">üîÑ Atualizar</button>
            </div>
            <div id="vendas-list" class="data-table">
                <p class="loading">Carregando...</p>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <h3>‚ö†Ô∏è Estoque Cr√≠tico</h3>
                <button class="btn btn-sm" onclick="refreshEstoque()">üîÑ Atualizar</button>
            </div>
            <div id="estoque-list" class="data-table">
                <p class="loading">Carregando...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Auto-refresh dashboard
    let refreshInterval;

    function refreshDashboard() {
        refreshVendas();
        refreshEstoque();
        updateStats();
    }

    function refreshVendas() {
        fetch('/api/vendas')
            .then(r => r.json())
            .then(vendas => {
                const container = document.getElementById('vendas-list');
                if (vendas.length === 0) {
                    container.innerHTML = '<p class="empty">Nenhuma venda hoje</p>';
                    return;
                }

                let html = '<table><thead><tr><th>Hora</th><th>Valor</th><th>Pagamento</th><th>Vendedor</th></tr></thead><tbody>';
                vendas.forEach(v => {
                    const hora = new Date(v.data_venda).toLocaleTimeString('pt-BR');
                    html += `<tr>
                    <td>${hora}</td>
                    <td>R$ ${parseFloat(v.valor_total).toFixed(2)}</td>
                    <td>${v.forma_pagamento || 'N/A'}</td>
                    <td>${v.vendedor || 'N/A'}</td>
                </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            })
            .catch(e => {
                console.error('Erro ao carregar vendas:', e);
                document.getElementById('vendas-list').innerHTML = '<p class="error">Erro ao carregar dados</p>';
            });
    }

    function refreshEstoque() {
        fetch('/api/estoque')
            .then(r => r.json())
            .then(produtos => {
                const container = document.getElementById('estoque-list');
                if (produtos.length === 0) {
                    container.innerHTML = '<p class="empty">‚úÖ Estoque OK!</p>';
                    return;
                }

                let html = '<table><thead><tr><th>Produto</th><th>Atual</th><th>M√≠nimo</th></tr></thead><tbody>';
                produtos.forEach(p => {
                    html += `<tr class="row-warning">
                    <td>${p.nome}</td>
                    <td>${p.quantidade_estoque} ${p.unidade_medida}</td>
                    <td>${p.estoque_minimo} ${p.unidade_medida}</td>
                </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            })
            .catch(e => {
                console.error('Erro ao carregar estoque:', e);
                document.getElementById('estoque-list').innerHTML = '<p class="error">Erro ao carregar dados</p>';
            });
    }

    function updateStats() {
        // Recarrega p√°gina inteira para atualizar stats (simples)
        // Pode ser otimizado para AJAX se necess√°rio
    }

    // Inicia auto-refresh
    document.addEventListener('DOMContentLoaded', function () {
        refreshDashboard();
        refreshInterval = setInterval(refreshDashboard, 30000); // 30s
    });

    // Limpa interval ao sair
    window.addEventListener('beforeunload', function () {
        if (refreshInterval) clearInterval(refreshInterval);
    });
</script>
{% endblock %}